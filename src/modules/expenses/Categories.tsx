"use client";

import React, { useEffect, useMemo, useState } from "react";
import { Car, Gamepad2 } from "lucide-react";
import CategoryCard from "./CardCategories";
import ExpensesDonutCard from "./ExpensesDonutWidget";
import AddExpenseModal from "./AddExpenseModal";
import { useExpensesCategoriesBreakdown } from "./hooks/useExpensesCategoriesBreakdown";

const categoryMeta: Record<
  string,
  { title: string; color: string; icon: React.ReactNode }
> = {
  FOOD: {
    title: "Food",
    color: "#1D4ED8",
    icon: (
      <svg width="20" height="20" viewBox="0 0 24 24" className="text-[#3447AA]" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M19.5 7.5H3C2.80109 7.5 2.61032 7.57902 2.46967 7.71967C2.32902 7.86032 2.25 8.05109 2.25 8.25V12.75C2.25224 14.0269 2.52531 15.2887 3.05117 16.4523C3.57703 17.6158 4.34372 18.6546 5.30063 19.5H3C2.80109 19.5 2.61032 19.579 2.46967 19.7197C2.32902 19.8603 2.25 20.0511 2.25 20.25C2.25 20.4489 2.32902 20.6397 2.46967 20.7803C2.61032 20.921 2.80109 21 3 21H19.5C19.6989 21 19.8897 20.921 20.0303 20.7803C20.171 20.6397 20.25 20.4489 20.25 20.25C20.25 20.0511 20.171 19.8603 20.0303 19.7197C19.8897 19.579 19.6989 19.5 19.5 19.5H17.1994C18.348 18.482 19.219 17.1887 19.7306 15.7416C20.6832 15.6829 21.5776 15.2632 22.2315 14.568C22.8854 13.8728 23.2497 12.9544 23.25 12V11.25C23.25 10.2554 22.8549 9.30161 22.1516 8.59835C21.4484 7.89509 20.4946 7.5 19.5 7.5ZM10.5 5.25V2.25C10.5 2.05109 10.579 1.86032 10.7197 1.71967C10.8603 1.57902 11.0511 1.5 11.25 1.5C11.4489 1.5 11.6397 1.57902 11.7803 1.71967C11.921 1.86032 12 2.05109 12 2.25V5.25C12 5.44891 11.921 5.63968 11.7803 5.78033C11.6397 5.92098 11.4489 6 11.25 6C11.0511 6 10.8603 5.92098 10.7197 5.78033C10.579 5.63968 10.5 5.44891 10.5 5.25Z"
          fill="currentColor"
        />
      </svg>
    ),
  },
  TRANSPORT: {
    title: "Transport",
    color: "#F43F5E",
    icon: <Car size={20} className="text-pink-500" />,
  },
  ENTERTAINMENT: {
    title: "Entertainment",
    color: "#6366F1",
    icon: <Gamepad2 size={20} className="main-text-color" />,
  },
  HEALTH: {
    title: "Health",
    color: "#FB7185",
    icon: <span className="text-pink-400"><svg width="19" height="21" viewBox="0 0 19 21" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.00006 3C9.00006 2.40666 9.176 1.82664 9.50565 1.33329C9.83529 0.839943 10.3038 0.455426 10.852 0.228363C11.4002 0.00129984 12.0034 -0.0581102 12.5853 0.0576455C13.1673 0.173401 13.7018 0.459123 14.1214 0.878681C14.5409 1.29824 14.8267 1.83279 14.9424 2.41473C15.0582 2.99667 14.9988 3.59987 14.7717 4.14805C14.5446 4.69623 14.1601 5.16477 13.6668 5.49441C13.1734 5.82405 12.5934 6 12.0001 6C11.2044 6 10.4413 5.68393 9.87874 5.12132C9.31613 4.55871 9.00006 3.79565 9.00006 3ZM18.6826 9.945C18.642 9.85504 18.5842 9.77395 18.5123 9.70639C18.4403 9.63882 18.3558 9.58612 18.2635 9.55128C18.1712 9.51644 18.0729 9.50017 17.9743 9.50338C17.8757 9.50659 17.7787 9.52923 17.6888 9.57C17.6654 9.58125 15.1847 10.575 10.9219 7.67719C6.01974 4.34531 2.67193 6.94875 2.53037 7.06125C2.45005 7.12159 2.38267 7.19746 2.33223 7.28434C2.28179 7.37122 2.24932 7.46735 2.23674 7.56702C2.22417 7.6667 2.23175 7.76788 2.25903 7.86457C2.28631 7.96125 2.33274 8.05148 2.39556 8.12987C2.45838 8.20827 2.53631 8.27325 2.62472 8.32096C2.71314 8.36866 2.81024 8.39811 2.91025 8.40757C3.01027 8.41702 3.11117 8.40629 3.20695 8.376C3.30274 8.34571 3.39147 8.29649 3.46787 8.23125C3.49224 8.21156 5.82287 6.40313 9.47443 8.53781C9.07599 9.78938 8.27818 11.5209 7.10724 12.9441C5.36724 15.0516 3.25318 15.9966 0.825994 15.7566C0.627952 15.7365 0.43007 15.796 0.27588 15.9219C0.12169 16.0478 0.0238219 16.2298 0.00380638 16.4278C-0.0162092 16.6259 0.0432668 16.8237 0.169151 16.9779C0.295034 17.1321 0.477014 17.23 0.675056 17.25C0.965999 17.2795 1.25825 17.2942 1.55068 17.2941C4.11756 17.2941 6.42568 16.1334 8.26599 13.9022C8.31943 13.8375 8.37287 13.7709 8.42443 13.7053C10.2479 14.1834 13.5001 15.5906 13.5001 19.5C13.5001 19.6989 13.5791 19.8897 13.7197 20.0303C13.8604 20.171 14.0511 20.25 14.2501 20.25C14.449 20.25 14.6397 20.171 14.7804 20.0303C14.921 19.8897 15.0001 19.6989 15.0001 19.5C15.0001 17.1891 14.0551 15.2484 12.2672 13.8881C11.3795 13.2319 10.387 12.7307 9.33193 12.4059C9.92092 11.4497 10.4068 10.4337 10.7813 9.375C13.2319 10.8834 15.1726 11.25 16.471 11.25C17.6129 11.25 18.2579 10.9688 18.3151 10.9425C18.4048 10.9013 18.4856 10.8428 18.5527 10.7703C18.6198 10.6978 18.6719 10.6128 18.7061 10.5201C18.7402 10.4274 18.7557 10.3289 18.7517 10.2302C18.7476 10.1315 18.7241 10.0346 18.6826 9.945Z" fill="#F6C1C4"/>
</svg>

</span>,
  },
  HOUSING: {
    title: "Housing",
    color: "#5C6EDC",
    icon: <span className="text-indigo-500"><svg width="23" height="19" viewBox="0 0 23 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M21.75 17.2502H20.25V10.5002L20.4694 10.7196C20.6104 10.8603 20.8015 10.9393 21.0007 10.9391C21.1999 10.939 21.3908 10.8597 21.5316 10.7187C21.6723 10.5777 21.7513 10.3866 21.7511 10.1874C21.7509 9.98819 21.6716 9.79722 21.5306 9.65649L12.3103 0.438992C12.029 0.1579 11.6477 0 11.25 0C10.8523 0 10.471 0.1579 10.1897 0.438992L0.969375 9.65649C0.828769 9.79722 0.749827 9.98805 0.749914 10.187C0.750002 10.3859 0.829113 10.5767 0.969844 10.7173C1.11057 10.8579 1.3014 10.9368 1.50033 10.9367C1.69927 10.9366 1.89002 10.8575 2.03062 10.7168L2.25 10.5002V17.2502H0.75C0.551088 17.2502 0.360322 17.3293 0.21967 17.4699C0.0790176 17.6106 0 17.8013 0 18.0002C0 18.1992 0.0790176 18.3899 0.21967 18.5306C0.360322 18.6712 0.551088 18.7502 0.75 18.7502H21.75C21.9489 18.7502 22.1397 18.6712 22.2803 18.5306C22.421 18.3899 22.5 18.1992 22.5 18.0002C22.5 17.8013 22.421 17.6106 22.2803 17.4699C22.1397 17.3293 21.9489 17.2502 21.75 17.2502ZM13.5 17.2502H9V12.7502C9 12.6508 9.03951 12.5554 9.10983 12.4851C9.18016 12.4148 9.27554 12.3752 9.375 12.3752H13.125C13.2245 12.3752 13.3198 12.4148 13.3902 12.4851C13.4605 12.5554 13.5 12.6508 13.5 12.7502V17.2502Z" fill="#5C6EDC"/>
</svg>
</span>,
  },
};


export default function Categories() {
  const [open, setOpen] = useState(false);
  const { data, isLoading, isError } = useExpensesCategoriesBreakdown();

  const categories = useMemo(() => {
    const items = data?.data ?? [];

    return items.map((x) => {
      const meta = categoryMeta[x.category] ?? {
        title: x.category,
        color: "#C5CAE61A",
        icon: <span><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9.75 0C7.82164 0 5.93657 0.571828 4.33319 1.64317C2.72982 2.71451 1.48013 4.23726 0.742179 6.01884C0.00422452 7.80042 -0.188858 9.76082 0.187348 11.6521C0.563554 13.5434 1.49215 15.2807 2.85571 16.6443C4.21928 18.0079 5.95656 18.9365 7.84787 19.3127C9.73919 19.6889 11.6996 19.4958 13.4812 18.7578C15.2627 18.0199 16.7855 16.7702 17.8568 15.1668C18.9282 13.5634 19.5 11.6784 19.5 9.75C19.4968 7.16513 18.4685 4.68705 16.6407 2.85927C14.813 1.03149 12.3349 0.00322505 9.75 0ZM13.5 10.5H10.5V13.5C10.5 13.6989 10.421 13.8897 10.2803 14.0303C10.1397 14.171 9.94892 14.25 9.75 14.25C9.55109 14.25 9.36033 14.171 9.21967 14.0303C9.07902 13.8897 9 13.6989 9 13.5V10.5H6C5.80109 10.5 5.61033 10.421 5.46967 10.2803C5.32902 10.1397 5.25 9.94891 5.25 9.75C5.25 9.55109 5.32902 9.36032 5.46967 9.21967C5.61033 9.07902 5.80109 9 6 9H9V6C9 5.80109 9.07902 5.61032 9.21967 5.46967C9.36033 5.32902 9.55109 5.25 9.75 5.25C9.94892 5.25 10.1397 5.32902 10.2803 5.46967C10.421 5.61032 10.5 5.80109 10.5 6V9H13.5C13.6989 9 13.8897 9.07902 14.0303 9.21967C14.171 9.36032 14.25 9.55109 14.25 9.75C14.25 9.94891 14.171 10.1397 14.0303 10.2803C13.8897 10.421 13.6989 10.5 13.5 10.5Z" fill="#C5CAE6"/>
</svg>
</span>,
      };

      return {
        title: meta.title,
        percent: x.percentage,
        amount: Number(x.totalAmount),
        icon: meta.icon,
        color: meta.color,
      };
    });
  }, [data]);

  const [activeId, setActiveId] = useState<string>("");

  useEffect(() => {
    if (!activeId && categories.length > 0) {
      setActiveId(categories[0].title);
    }
  }, [activeId, categories]);

  return (
    <div className="pt-10 p-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-xl font-bold">Categories</h1>

        <button
          onClick={() => setOpen(true)}
          className="main-bg-color text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition"
        >
          Add new Expenses
        </button>
      </div>

      <div className="flex flex-col lg:flex-row gap-6">
        <div className="w-full lg:w-[100%] space-y-4">
          {isLoading && <p>Loading...</p>}
          {isError && <p>Failed to load categories</p>}

          {!isLoading &&
            !isError &&
            categories.map((cat) => (
              <CategoryCard
                key={cat.title}
                title={cat.title}
                percent={cat.percent}
                amount={cat.amount}
                icon={cat.icon}
                color={cat.color}
                active={activeId === cat.title}
                onClick={() => setActiveId(cat.title)}
              />
            ))}
        </div>

        <div className="w-full lg:w-[35%] bg-[#F9F9FA]">
          <ExpensesDonutCard />
        </div>
      </div>

      <AddExpenseModal
        open={open}
        onClose={() => setOpen(false)}
        onSave={(d) => console.log("Saved:", d)}
      />
    </div>
  );
}