"use client";

import { useEffect, useState } from "react";

type ApiData = {
  totalBalance: number;
  totalIncome: number;
  totalExpenses: number;
};

const CARD_BASE =
  "flex flex-1 items-center gap-1  h-[99px] bg-white rounded-[16px] p-[16px]";

const ICON_BASE =
  "flex items-center justify-center w-[45px] h-[45px] rounded-[8px]";

const formatMoney = (num: number, currencyCode: string) => {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: currencyCode,
  }).format(num);
};
export default function FinancialOverview() {
  const [data, setData] = useState<ApiData | null>(null);
  const API_BASE_URL = process.env.NEXT_PUBLIC_BASE_URL;
  type Currency = {
    id: string;
    code: string;
    symbol: string;
    name: string;
  };

  const [currencies, setCurrencies] = useState<Currency[]>([]);
  const [selectedCurrency, setSelectedCurrency] = useState<string>("USD");
  useEffect(() => {
    const token = sessionStorage.getItem("token");

    if (!token) return;

    fetch(`${API_BASE_URL}/expenses/overview`, {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (!res.ok) throw new Error("Unauthorized");
        return res.json();
      })
      .then((result) => {
        console.log(result.data);
        setData(result.data ?? []);
      })
      .catch((err) => console.error(err));
  }, []);
  useEffect(() => {
    const token = sessionStorage.getItem("token");
    const storedCurrencyId = sessionStorage.getItem("currencyId");

    if (!token) return;

    fetch(`${API_BASE_URL}/currencies`, {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (!res.ok) throw new Error("Unauthorized");
        return res.json();
      })
      .then((result) => {
        const list: Currency[] = result.data;
        setCurrencies(list);

        if (storedCurrencyId) {
          const matched = list.find((c) => c.id === storedCurrencyId);

          if (matched) {
            setSelectedCurrency(matched.code);
            return;
          }
        }

        if (list.length > 0) {
          setSelectedCurrency(list[0].code);
        }
      })
      .catch((err) => console.error(err));
  }, []);
  const netBalance = data ? data.totalIncome - data.totalExpenses : 0;

  return (
    <div className="mt-[-40px] pt-[60px] flex justify-center w-full min-h-[252px] bg-[#f6f6f7b3] rounded-[16px] pb-3">
      <div className="w-[89%] flex flex-col">
        <div className="w-[210px]">
          <h3 className="font-medium text-2xl">Financial Overview</h3>
          <div className="mt-2 h-[2px] rounded-[16px] hero-gradient" />
        </div>

        <div className="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mt-4 ">
          <div className={CARD_BASE}>
            <div className={`${ICON_BASE} bg-[rgba(22,97,224,0.13)]`}>
              <svg
                width="22"
                height="22"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <g clipPath="url(#clip0_1744_1406)">
                  <path
                    d="M7.80269 5.35415H14.1973L16.2226 1.61518C16.2878 1.49489 16.313 1.35699 16.2946 1.22144C16.2761 1.08588 16.2151 0.9597 16.1202 0.861157C16.0253 0.762613 15.9015 0.696816 15.7667 0.673288C15.632 0.64976 15.4932 0.669721 15.3706 0.730283C13.9212 1.44588 12.6538 1.14051 11.1863 0.787087C9.73508 0.437537 8.09045 0.0413647 6.13791 0.697197C6.0488 0.727134 5.96731 0.776203 5.89917 0.840963C5.83102 0.905722 5.77787 0.984605 5.74343 1.07208C5.709 1.15955 5.69412 1.2535 5.69983 1.34733C5.70554 1.44117 5.73171 1.53262 5.7765 1.61527L7.80269 5.35415ZM14.8716 6.90498C14.7878 6.81821 14.7034 6.73084 14.6186 6.64287H7.38151C7.29675 6.73073 7.2124 6.8181 7.12847 6.90498C5.82175 8.25695 4.58743 9.53402 3.66863 10.9635C2.6122 12.6073 2.12012 14.2186 2.12012 16.0347C2.12012 18.1419 3.25625 19.7507 5.40559 20.687C7.24393 21.4879 9.46227 21.656 10.9995 21.656C12.548 21.656 14.7786 21.4878 16.6116 20.6867C18.7499 19.7522 19.8801 18.1435 19.8801 16.0347C19.8801 14.2186 19.3881 12.6072 18.3316 10.9635C17.4128 9.53402 16.1785 8.25695 14.8716 6.90498ZM11.132 12.8748C11.5937 12.972 12.071 13.0725 12.4804 13.3423C13.0123 13.693 13.2821 14.2349 13.2821 14.9532C13.2821 15.9013 12.5896 16.7037 11.6439 16.9592V17.2917C11.6439 17.4626 11.576 17.6266 11.4551 17.7474C11.3342 17.8683 11.1703 17.9362 10.9994 17.9362C10.8284 17.9362 10.6645 17.8683 10.5436 17.7474C10.4227 17.6266 10.3548 17.4626 10.3548 17.2917V16.9592C9.40908 16.7037 8.71664 15.9013 8.71664 14.9532C8.71664 14.7822 8.78454 14.6183 8.90542 14.4974C9.02629 14.3765 9.19023 14.3086 9.36117 14.3086C9.53211 14.3086 9.69605 14.3765 9.81692 14.4974C9.93779 14.6183 10.0057 14.7822 10.0057 14.9532C10.0057 15.3957 10.4515 15.7556 10.9994 15.7556C11.5472 15.7556 11.993 15.3956 11.993 14.9532C11.993 14.4547 11.8351 14.34 10.8666 14.1363C10.4051 14.0392 9.92771 13.9386 9.51835 13.6689C8.98635 13.3182 8.71664 12.7762 8.71664 12.058C8.71664 11.1092 9.40908 10.3064 10.3548 10.0508V9.71943C10.3548 9.54849 10.4227 9.38455 10.5436 9.26368C10.6645 9.14281 10.8284 9.0749 10.9994 9.0749C11.1703 9.0749 11.3342 9.14281 11.4551 9.26368C11.576 9.38455 11.6439 9.54849 11.6439 9.71943V10.0506C12.5896 10.3063 13.2821 11.1091 13.2821 12.0578C13.2821 12.2288 13.2142 12.3927 13.0933 12.5136C12.9724 12.6345 12.8085 12.7024 12.6375 12.7024C12.4666 12.7024 12.3027 12.6345 12.1818 12.5136C12.0609 12.3927 11.993 12.2288 11.993 12.0578C11.993 11.6147 11.5472 11.2543 10.9994 11.2543C10.4515 11.2543 10.0057 11.6148 10.0057 12.0578C10.0059 12.5565 10.1638 12.671 11.1322 12.8748H11.132Z"
                    fill="#3447AA"
                  />
                </g>
                <defs>
                  <clipPath id="clip0_1744_1406">
                    <rect width="22" height="22" fill="white" />
                  </clipPath>
                </defs>
              </svg>
            </div>
            <div className="ml-3 flex flex-col">
              <span className="text-sm text-[rgba(145,145,145,1)]">
                Total balance
              </span>
              <span className="text-base">
                {data ? formatMoney(data.totalBalance, selectedCurrency) : "--"}
              </span>

              <div className="flex text-xs text-green-500 gap-2">
                {/* <svg
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12.4986 5.13189L12.4938 5.12714L7.59939 0.226296C7.56049 0.187619 7.51753 0.153256 7.47126 0.123805L7.33033 0.046929L7.23423 0.0148873H7.16375C7.05575 -0.00496244 6.94503 -0.00496244 6.83703 0.0148873H6.6961L6.58718 0.0725444C6.52648 0.105516 6.47046 0.146448 6.42061 0.194255L1.50697 5.12714C1.17793 5.45357 1.1758 5.98494 1.50222 6.31398L1.50697 6.31872C1.83864 6.63518 2.36044 6.63518 2.69215 6.31872L5.61983 3.39743C5.74614 3.27359 5.94896 3.27557 6.0728 3.40191C6.13043 3.46067 6.16322 3.53937 6.16436 3.62167V13.1607C6.16433 13.6242 6.54003 14 7.00354 14C7.46705 14 7.84278 13.6243 7.84284 13.1608V3.62167C7.84534 3.44479 7.99074 3.30338 8.16761 3.30587C8.2499 3.30704 8.3286 3.33981 8.38737 3.39743L11.3023 6.31872C11.6348 6.63926 12.1613 6.63926 12.4938 6.31872C12.8229 5.9923 12.825 5.46093 12.4986 5.13189Z"
                    fill="#16C087"
                  />
                </svg>
                +8.2% from last month */}
              </div>
            </div>
          </div>

          <div className={CARD_BASE}>
            <div className={`${ICON_BASE} bg-[rgba(207,70,87,0.13)]`}>
              <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9.16949 1.67593L9.16319 16.3059L6.42303 13.572C6.34555 13.4925 6.25299 13.4293 6.15078 13.386C6.04856 13.3428 5.93875 13.3203 5.82776 13.32C5.66345 13.3223 5.50349 13.3731 5.36792 13.466C5.23234 13.5588 5.12719 13.6896 5.06564 13.842C5.0041 13.9943 4.98889 14.1615 5.02193 14.3224C5.05497 14.4834 5.13479 14.631 5.25138 14.7468L9.41516 18.9169C9.49267 18.9945 9.58473 19.0561 9.68606 19.0981C9.78739 19.1401 9.89601 19.1617 10.0057 19.1617C10.1154 19.1617 10.224 19.1401 10.3254 19.0981C10.4267 19.0561 10.5187 18.9945 10.5963 18.9169L14.76 14.7468C15.5758 13.9594 14.36 12.7531 13.5789 13.572L10.8293 16.3216L10.8356 1.67593C10.8426 1.56222 10.8263 1.44829 10.7876 1.34114C10.7489 1.23399 10.6886 1.1359 10.6106 1.05291C10.5325 0.969915 10.4383 0.903778 10.3338 0.858569C10.2292 0.813361 10.1165 0.790039 10.0026 0.790039C9.88864 0.790039 9.77592 0.813361 9.67135 0.858569C9.56678 0.903778 9.47257 0.969915 9.39453 1.05291C9.31648 1.1359 9.25625 1.23399 9.21755 1.34114C9.17885 1.44829 9.16249 1.56222 9.16949 1.67593Z"
                  fill="#FF5050"
                />
              </svg>
            </div>
            <div className="ml-3 flex flex-col">
              <span className="text-sm text-[rgba(145,145,145,1)]">
                Total expense
              </span>
              <span className="text-base">
                {data
                  ? formatMoney(data.totalExpenses, selectedCurrency)
                  : "--"}
              </span>
              <div className="flex text-xs text-[rgba(255,80,80,1)] gap-2">
                {/* <svg
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g clipPath="url(#clip0_1744_1430)">
                    <path
                      d="M7 0C3.13359 0 0 3.13359 0 7C0 10.8664 3.13359 14 7 14C10.8664 14 14 10.8664 14 7C14 3.13359 10.8664 0 7 0ZM7.98438 10.4945C7.98438 11.0387 7.54414 11.4789 7 11.4789C6.45586 11.4789 6.01562 11.0387 6.01562 10.4945V6.3793C6.01562 5.83516 6.45586 5.39492 7 5.39492C7.54414 5.39492 7.98438 5.83516 7.98438 6.3793V10.4945ZM7 4.48984C6.45586 4.48984 6.01562 4.04961 6.01562 3.50547C6.01562 2.96133 6.45586 2.52109 7 2.52109C7.54414 2.52109 7.98438 2.96133 7.98438 3.50547C7.98438 4.04961 7.54414 4.48984 7 4.48984Z"
                      fill="#FF5050"
                    />
                  </g>
                  <defs>
                    <clipPath id="clip0_1744_1430">
                      <rect width="14" height="14" fill="white" />
                    </clipPath>
                  </defs>
                </svg>
                8.3% vs last month */}
              </div>
            </div>
          </div>

          <div className={CARD_BASE}>
            <div className={`${ICON_BASE} bg-[rgba(220,252,231,1)]`}>
              <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9.99395 0.837507C9.77721 0.841441 9.5705 0.929545 9.41757 1.08318L5.25379 5.25011C5.16568 5.3246 5.09396 5.41656 5.04318 5.52017C4.9924 5.62378 4.96366 5.73679 4.95876 5.85207C4.95386 5.96735 4.97292 6.0824 5.01473 6.18994C5.05654 6.29748 5.1202 6.39519 5.20168 6.47689C5.28316 6.55858 5.3807 6.6225 5.48813 6.6646C5.59556 6.7067 5.71055 6.72607 5.82584 6.72148C5.94114 6.71689 6.05423 6.68845 6.15797 6.63794C6.26172 6.58744 6.35386 6.51597 6.42859 6.42806L9.1656 3.69105L9.1719 18.3273C9.1719 18.5486 9.25984 18.7609 9.41636 18.9175C9.57289 19.074 9.78519 19.1619 10.0065 19.1619C10.2279 19.1619 10.4402 19.074 10.5967 18.9175C10.7533 18.7609 10.8412 18.5486 10.8412 18.3273L10.8317 3.6753L13.5813 6.42806C13.7395 6.57508 13.9484 6.65511 14.1643 6.65133C14.3802 6.64755 14.5862 6.56025 14.7391 6.40778C14.892 6.25531 14.9798 6.04953 14.9842 5.83365C14.9885 5.61778 14.9091 5.40862 14.7625 5.25011L10.5987 1.08318C10.5195 1.0037 10.4252 0.940986 10.3213 0.898777C10.2174 0.856567 10.1061 0.835729 9.99395 0.837507Z"
                  fill="#16C087"
                />
              </svg>
            </div>
            <div className="ml-3 flex flex-col ">
              <span className="text-sm text-[rgba(145,145,145,1)]">
                Total Income
              </span>
              <span className="text-base">
                {data ? formatMoney(data.totalIncome, selectedCurrency) : "--"}
              </span>
              <div className="flex text-xs text-[rgba(72,185,113,1)] gap-2">
                {/* <svg
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g clipPath="url(#clip0_1744_1447)">
                    <path
                      d="M7 0C3.14035 0 0 3.14035 0 7C0 10.8596 3.14035 14 7 14C10.8596 14 14 10.8596 14 7C14 3.14035 10.8596 0 7 0ZM10.9123 5.15789L6.4386 9.59649C6.17544 9.85965 5.75439 9.87719 5.47368 9.61403L3.10526 7.45614C2.82456 7.19298 2.80702 6.75439 3.05263 6.47368C3.31579 6.19298 3.75439 6.17544 4.03509 6.4386L5.91228 8.1579L9.91228 4.15789C10.193 3.87719 10.6316 3.87719 10.9123 4.15789C11.193 4.4386 11.193 4.87719 10.9123 5.15789Z"
                      fill="#16C087"
                    />
                  </g>
                  <defs>
                    <clipPath id="clip0_1744_1447">
                      <rect width="14" height="14" fill="white" />
                    </clipPath>
                  </defs>
                </svg>
                12% vs last month */}
              </div>
            </div>
          </div>

          <div className={CARD_BASE}>
            <div className={`${ICON_BASE} bg-[rgba(246,244,250,1)]`}>
              <svg
                width="20"
                height="20"
                viewBox="0 0 20 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12.8125 13.4373C12.8125 12.8964 12.8125 11.2498 14.375 11.2498H17.5V9.3748C17.5 8.51324 16.7991 7.8123 15.9375 7.8123H2.5C1.63844 7.8123 0.9375 8.51324 0.9375 9.3748V17.4998C0.9375 18.3614 1.63844 19.0623 2.5 19.0623H15.9375C16.7991 19.0623 17.5 18.3614 17.5 17.4998V15.6248H14.375C12.8125 15.6248 12.8125 13.9782 12.8125 13.4373ZM13.4375 7.1873V5.29293C13.4375 4.97012 13.2691 4.6773 12.9869 4.5098C12.8448 4.42455 12.6828 4.37811 12.5171 4.37515C12.3514 4.37219 12.1879 4.4128 12.0428 4.49293L6.63938 7.1873H13.4375Z"
                  fill="#686FFF"
                />
                <path
                  d="M15.3125 14.0625C15.6577 14.0625 15.9375 13.7827 15.9375 13.4375C15.9375 13.0923 15.6577 12.8125 15.3125 12.8125C14.9673 12.8125 14.6875 13.0923 14.6875 13.4375C14.6875 13.7827 14.9673 14.0625 15.3125 14.0625Z"
                  fill="#686FFF"
                />
                <path
                  d="M10.6251 4.50167V3.17136C10.6286 2.98237 10.577 2.79646 10.4765 2.63639C10.3759 2.47631 10.2309 2.34902 10.0592 2.27011C9.7273 2.11948 9.36355 2.17511 9.08605 2.41854L3.64355 7.18729H5.23918L10.6251 4.50167ZM18.1251 11.8748H14.3751C13.8123 11.8748 13.4376 12.1407 13.4376 13.4373C13.4376 14.7339 13.8123 14.9998 14.3751 14.9998H18.1251C18.642 14.9998 19.0626 14.5792 19.0626 14.0623V12.8123C19.0626 12.2954 18.642 11.8748 18.1251 11.8748ZM15.3126 14.6873C14.6232 14.6873 14.0626 14.1267 14.0626 13.4373C14.0626 12.7479 14.6232 12.1873 15.3126 12.1873C16.002 12.1873 16.5626 12.7479 16.5626 13.4373C16.5626 14.1267 16.002 14.6873 15.3126 14.6873ZM19.3061 2.74917L17.8686 0.815419C17.8252 0.757068 17.7688 0.709677 17.7038 0.677036C17.6388 0.644395 17.5671 0.627411 17.4944 0.627441C17.4217 0.627472 17.35 0.644516 17.2851 0.677211C17.2201 0.709906 17.1638 0.757344 17.1204 0.815731L15.6917 2.73979C15.66 2.77129 15.6385 2.81147 15.6297 2.85525C15.6209 2.89902 15.6254 2.94441 15.6425 2.98566C15.6595 3.02691 15.6885 3.06216 15.7256 3.08693C15.7628 3.1117 15.8064 3.12488 15.8511 3.12479H16.5567C16.6498 3.5817 16.5989 4.05624 16.411 4.483C16.2231 4.90977 15.9075 5.26775 15.5076 5.50761L15.3126 5.62479L16.5626 6.56229L16.6176 6.52573C17.1774 6.15241 17.6365 5.64668 17.9539 5.05341C18.2714 4.46014 18.4376 3.79767 18.4376 3.12479H19.1504C19.194 3.12482 19.2365 3.11193 19.2727 3.08776C19.3089 3.06358 19.3371 3.02922 19.3538 2.989C19.3705 2.94879 19.3748 2.90453 19.3663 2.86184C19.3578 2.81915 19.3368 2.77994 19.3061 2.74917Z"
                  fill="#686FFF"
                />
              </svg>
            </div>
            <div className="ml-3 flex flex-col ">
              <span className="text-sm text-[rgba(145,145,145,1)]">
                Net balance
              </span>
              <span className="text-base">
                {data ? formatMoney(netBalance, selectedCurrency) : "--"}
              </span>
              <div className="flex text-xs text-[rgba(104,111,255,1)] gap-2">
                {/* <svg
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M7 0C3.14035 0 0 3.14035 0 7C0 10.8596 3.14035 14 7 14C10.8596 14 14 10.8596 14 7C14 3.14035 10.8596 0 7 0ZM10.9123 5.15789L6.4386 9.59649C6.17544 9.85965 5.75439 9.87719 5.47368 9.61403L3.10526 7.45614C2.82456 7.19298 2.80702 6.75439 3.05263 6.47368C3.31579 6.19298 3.75439 6.17544 4.03509 6.4386L5.91228 8.1579L9.91228 4.15789C10.193 3.87719 10.6316 3.87719 10.9123 4.15789C11.193 4.4386 11.193 4.87719 10.9123 5.15789Z"
                    fill="#686FFF"
                  />
                </svg>

                {netBalance >= 0 ? "Positive" : "Negative"} */}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
